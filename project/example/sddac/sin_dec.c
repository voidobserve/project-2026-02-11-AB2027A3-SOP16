#include "include.h"
#include "driver_sddac.h"
#include "res.h"
#include "api_codec.h"
#include "driver_gpio.h"

#define SDDAC_BUF_SIZE 64

void tone_play_volume_set(int8_t vol);
uint16_t tone_play_volume_get(void);
void tone_play_volume_proc(int16_t *dest, int16_t *src, uint16_t len);

typedef struct {
    uint8_t sta;
    int16_t *ibuf_ptr;
    uint16_t offset;
    uint16_t len;
    int16_t obuf[SDDAC_BUF_SIZE];
} sin_res_cb_t;

sin_res_cb_t sin_res_cb;

//test sddac_buf
int16_t SinData16[] = {
    1, 0, 1, -1, 0, 0, 0, 0, 1, -2, -4, -10, -17, -24, -28, -21, 0, 41, 103, 177, 247, 290, 276, 184, 0, -271, -596, -918, -1164, -1249, -1102, -684, 0, 882, 1844, 2719, 3307, 3419, 2914, 1747, -1, -2108, -4248, -6015, -7019, -6956, -5683, -3266, 0, 3638, 7051, 9632, 10865, 10433, 8285, 4650, 0, -4988, -9537, -12883, -14406, -13739, -10846, -6048, 0, 6399, 12144, 16276, 18047, 17059, 13343, 7370, 0, -7647, -14366, -19060, -20924, -19580, -15165, -8295, 0, 8448, 15729, 20690, 22530, 20923, 16087, 8740, -1, -8793, -16283, -21313, -23103, -21369, -16370, -8865, 1, 8872, 16398, 21427, 23195, 21430, 16402, 8877, 0, -8878, -16402, -21431, -23196, -21431, -16404, -8877, 0, 8877, 16402, 21432, 23197, 21431, 16402, 8878, 0, -8877, -16402, -21431, -23198, -21431, -16404, -8878, -1, 8878, 16402, 21431, 23196, 21431, 16402, 8878, 0, -8877, -16404, -21430, -23197, -21431, -16404, -8877, 1, 8878, 16402, 21431, 23198, 21432, 16404, 8878, -1, -8878, -16404, -21430, -23197, -21431, -16402, -8878, 0, 8877, 16404, 21431, 23197, 21431, 16404, 8878, 0, -8877, -16402, -21431, -23197, -21431, -16402, -8877, 0, 8878, 16404, 21431, 23197, 21432, 16402, 8877, 0, -8878, -16402, -21431, -23197, -21431, -16402, -8877, 0, 8877, 16402, 21431, 23197, 21431, 16402, 8878, -1, -8877, -16402, -21431, -23197, -21431, -16402, -8877, 0, 8877, 16402, 21432, 23197, 21431, 16402, 8877, 0, -8878, -16402, -21431, -23197, -21431, -16402, -8878, 0, 8878, 16402, 21431, 23197, 21431, 16404, 8878, 0, -8878, -16404, -21431, -23196, -21431, -16402, -8878, 0, 8878, 16404, 21430, 23197, 21432, 16404, 8878, 1, -8878, -16402, -21431, -23197, -21432, -16402, -8877, 0, 8877, 16404, 21431, 23197, 21431, 16402, 8877, 0, -8877, -16404, -21431, -23197, -21431, -16404, -8877, 1, 8878, 16404, 21432, 23198, 21431, 16404, 8877, 1, -8877, -16404, -21431, -23197, -21432, -16402, -8878, 0, 8877, 16404, 21431, 23197, 21431, 16404, 8878, 1, -8877, -16404, -21432, -23197, -21431, -16404, -8878, 0, 8878, 16402, 21431, 23197, 21431, 16402, 8878, 0, -8877, -16402, -21431, -23198, -21432, -16404, -8878, 0, 8878, 16402, 21430, 23198, 21432, 16404, 8878, -1, -8878, -16404, -21430, -23197, -21431, -16402, -8877, 0, 8877, 16404, 21430, 23197, 21430, 16404, 8877, 1, -8878, -16404, -21432, -23197, -21431, -16402, -8878, 0, 8877, 16402, 21432, 23197, 21431, 16404, 8877, 1, -8878, -16404, -21431, -23197, -21431, -16402, -8877, -1, 8878, 16402, 21430, 23197, 21431, 16404, 8877, 0, -8878, -16402, -21431, -23197, -21431, -16404, -8878, 0, 8877, 16404, 21431, 23196, 21431, 16402, 8878, 0, -8878, -16402, -21431, -23197, -21431, -16404, -8878, 0, 8878, 16402, 21431, 23197, 21432, 16404, 8877, 0, -8877, -16402, -21431, -23197, -21431, -16404, -8877, 0, 8877, 16402, 21432, 23196, 21431, 16404, 8878, 0, -8877, -16404, -21431, -23197, -21431, -16402, -8878, 1, 8877, 16404, 21431, 23197, 21431, 16402, 8877, 0, -8878, -16402, -21431, -23197, -21432, -16404, -8878, 0, 8878, 16402, 21431, 23198, 21431, 16404, 8877, 0, -8877, -16402, -21431, -23197, -21431, -16404, -8877, 0, 8877, 16404, 21432, 23197, 21431, 16402, 8877, 0, -8878, -16402, -21430, -23197, -21431, -16404, -8877, 1, 8877, 16404, 21432, 23197, 21431, 16404, 8877, 0, -8877, -16402, -21430, -23196, -21431, -16402, -8878, 1, 8877, 16404, 21431, 23197, 21432, 16404, 8878, 0, -8878, -16404, -21431, -23197, -21431, -16402, -8878, 0, 8877, 16402, 21431, 23197, 21432, 16402, 8877, 0, -8877, -16404, -21431, -23197, -21431, -16402, -8877, 0, 8878, 16404, 21431, 23197, 21431, 16404, 8877, 0, -8878, -16402, -21431, -23196, -21431, -16402, -8877, 0, 8877, 16402, 21431, 23197, 21431, 16402, 8878, 0, -8878, -16402, -21432, -23196, -21432, -16404, -8878, -1, 8878, 16404, 21431, 23198, 21431, 16402, 8877, 0, -8877, -16404, -21432, -23196, -21431, -16402, -8878, 0, 8878, 16402, 21430, 23197, 21431, 16404, 8878, 0, -8877, -16402, -21432, -23197, -21431, -16404, -8877, 0, 8877, 16402, 21430, 23197, 21432, 16402, 8877, 0, -8878, -16402, -21430, -23197, -21431, -16402, -8878, 0, 8877, 16402, 21432, 23197, 21431, 16402, 8878, 0, -8877, -16404, -21431, -23196, -21432, -16402, -8877, 0, 8877, 16402, 21431, 23198, 21431, 16402, 8877, -1, -8878, -16404, -21430, -23197, -21432, -16404, -8878, 0, 8878, 16404, 21431, 23197, 21431, 16402, 8878, 0, -8877, -16404, -21431, -23197, -21431, -16402, -8877, -1, 8878, 16402, 21431, 23197, 21431, 16402, 8877, 0, -8878, -16402, -21431, -23198, -21431, -16404, -8878, 0, 8877, 16402, 21431, 23196, 21431, 16402, 8877, 0, -8877, -16402, -21431, -23197, -21431, -16402, -8877, -1, 8878, 16402, 21431, 23197, 21431, 16402, 8878, 1, -8877, -16402, -21432, -23197, -21432, -16402, -8878, 0, 8878, 16402, 21431, 23197, 21431, 16404, 8877, 1, -8878, -16402, -21431, -23197, -21431, -16402, -8877, -1, 8877, 16402, 21431, 23197, 21431, 16402, 8877, 0, -8877, -16402, -21431, -23196, -21432, -16402, -8878, 0, 8877, 16402, 21431, 23197, 21432, 16404, 8877, 1, -8878, -16404, -21432, -23197, -21431, -16404, -8878, 0, 8877, 16402, 21432, 23197, 21431, 16404, 8878, 0, -8877, -16402, -21431, -23198, -21430, -16404, -8877, 0, 8878, 16402, 21430, 23197, 21431, 16402, 8878, 1, -8878, -16402, -21430, -23198, -21431, -16404, -8878, 0, 8877, 16404, 21431, 23196, 21431, 16402, 8878, 0, -8878, -16404, -21431, -23197, -21432, -16404, -8878, 0, 8878, 16402, 21432, 23196, 21431, 16402, 8878, 1, -8877, -16404, -21431, -23197, -21432, -16402, -8877, -1, 8878, 16404, 21431, 23197, 21431, 16404, 8877, 0, -8878, -16404, -21431, -23197, -21431, -16404, -8877, 0, 8878, 16402, 21431, 23198, 21431, 16402, 8878, 0, -8877, -16402, -21430, -23197, -21431, -16402, -8878, 0, 8877, 16404, 21431, 23197, 21432, 16402, 8878, 0, -8878, -16402, -21431, -23197, -21431, -16402, -8878, 0, 8877, 16402, 21432, 23197, 21431, 16402, 8877, 1, -8878, -16402, -21431, -23197, -21431, -16404, -8877, 0, 8878, 16404, 21432, 23197, 21431, 16404, 8878, 0, -8878, -16402, -21430, -23197, -21432, -16404, -8877, 0, 8878, 16404, 21431, 23197, 21432, 16404, 8877, 0, -8877, -16404, -21431, -23196, -21431, -16404, -8877, 0, 8878, 16402, 21431, 23197, 21431, 16402, 8878, 1, -8878, -16402, -21431, -23197, -21431, -16402, -8878, 0, 8877, 16402, 21431, 23197, 21431, 16404, 8878, -1, -8878, -16404, -21431, -23197, -21432, -16402, -8877, 0, 8877, 16402, 21431, 23197, 21431, 16402, 8878, 1, -8878, -16402, -21432, -23197, -21431, -16402, -8877, 0, 8877, 16402, 21432, 23197, 21431, 16402, 8878, 0, -8877, -16404, -21430, -23197, -21431, -16402, -8878, 0, 8878, 16404, 21430, 23198, 21431, 16402, 8877, 0, -8878, -16402, -21431, -23197, -21431, -16404, -8877, 0, 8878, 16402, 21431, 23197, 21431, 16402, 8877, 1, -8877, -16404, -21430, -23197, -21431, -16402, -8878, 0, 8878, 16402, 21431, 23197, 21431, 16404, 8878, 0, -8877, -16402, -21431, -23197, -21431, -16404, -8877, 0, 8877, 16404, 21431, 23197, 21431, 16402, 8878, 0, -8877, -16404, -21431, -23198, -21430, -16402, -8877, 0, 8877, 16404, 21432, 23197, 21431, 16402, 8877, 0, -8878, -16402, -21430, -23197, -21431, -16402, -8878, -1, 8877, 16404, 21430, 23197, 21431, 16402, 8877, 0, -8878, -16402, -21431, -23198, -21430, -16402, -8878, 0, 8878, 16402, 21431, 23197, 21432, 16402, 8877, -1, -8878, -16402, -21431, -23197, -21431, -16402, -8877, 1, 8878, 16402, 21431, 23196, 21432, 16402, 8878, -1, -8878, -16404, -21431, -23196, -21431, -16402, -8878, 0, 8878, 16402, 21431, 23197, 21431, 16402, 8877, 0, -8877, -16402, -21431, -23197, -21431, -16402, -8877, 0, 8878, 16402, 21431, 23197, 21431, 16402, 8877, 0, -8878, -16402, -21431, -23196, -21431, -16402, -8878, 0, 8877, 16402, 21431, 23197, 21431, 16404, 8877, 0, -8877, -16404, -21431, -23197, -21431, -16404, -8877, 0, 8878, 16402, 21432, 23196, 21431, 16402, 8877, 1, -8877, -16402, -21431, -23197, -21431, -16402, -8878, 0, 8878, 16404, 21432, 23198, 21431, 16402, 8877, 0, -8878, -16404, -21431, -23197, -21432, -16404, -8877, 0, 8878, 16402, 21431, 23197, 21432, 16404, 8877, 0, -8877, -16402, -21431, -23197, -21431, -16402, -8878, 1, 8878, 16402, 21431, 23196, 21430, 16404, 8877, 0, -8877, -16404, -21431, -23197, -21431, -16404, -8878, 0, 8877, 16402, 21431, 23197, 21431, 16404, 8877, 0, -8877, -16402, -21431, -23197, -21431, -16404, -8878, 0, 8878, 16402, 21431, 23197, 21431, 16402, 8877, 0, -8878, -16404, -21431, -23196, -21432, -16404, -8878, 0, 8878, 16402, 21431, 23197, 21431, 16402, 8877, 0, -8877, -16402, -21431, -23197, -21431, -16402, -8877, 0, 8878, 16404, 21431, 23197, 21431, 16404, 8877, -1, -8877, -16404, -21431, -23197, -21431, -16402, -8877, 0, 8877, 16402, 21431, 23197, 21432, 16404, 8877, 0, -8877, -16402, -21431, -23197, -21431, -16404, -8878, 0, 8878, 16404, 21431, 23197, 21431, 16404, 8878, 0, -8877, -16404, -21432, -23197, -21431, -16402, -8877, 1, 8878, 16402, 21432, 23197, 21431, 16404, 8877, 0, -8877, -16402, -21431, -23197, -21431, -16404, -8878, 1, 8878, 16404, 21432, 23197, 21431, 16404, 8877, 0, -8877, -16402, -21431, -23197, -21431, -16402, -8877, 0, 8877, 16404, 21432, 23197, 21432, 16402, 8877, 0, -8877, -16402, -21431, -23197, -21431, -16404, -8877, 0, 8877, 16404, 21431, 23196, 21431, 16404, 8878, 1, -8877, -16402, -21431, -23197, -21432, -16404, -8878, 0, 8878, 16402, 21431, 23197, 21431, 16402, 8878, 0, -8878, -16402, -21431, -23197, -21432, -16402, -8877, 0, 8877, 16402, 21430, 23197, 21431, 16404, 8877, 0, -8878, -16402, -21431, -23197, -21431, -16402, -8878, 0, 8877, 16404, 21431, 23197, 21431, 16402, 8877, -1, -8877, -16404, -21431, -23197, -21431, -16404, -8877, 0, 8878, 16402, 21431, 23197, 21431, 16404, 8878, 0, -8878, -16404, -21431, -23197, -21431, -16402, -8878, 1, 8877, 16404, 21431, 23197, 21432, 16402, 8878, -1, -8877, -16404, -21430, -23198, -21431, -16402, -8878, 1, 8877, 16404, 21431, 23197, 21431, 16404, 8878, 0, -8878, -16404, -21431, -23197, -21430, -16404, -8878, 0, 8877, 16402, 21431, 23197, 21431, 16402, 8877, 0, -8877, -16402, -21431, -23196, -21431, -16402, -8877, 0, 8877, 16404, 21432, 23197, 21431, 16402, 8877, 0, -8877, -16402, -21431, -23198, -21432, -16402, -8877, 0, 8878, 16404, 21432, 23197, 21431, 16404, 8878, 0, -8878, -16402, -21431, -23197, -21431, -16404, -8877, 0, 8877, 16402, 21427, 23188, 21414, 16380, 8857, 1, -8830, -16277, -21200, -22857, -21014, -15989, -8591, 0, 8434, 15406, 19864, 21182, 19242, 14454, 7661, 0, -7301, -13130, -16662, -17480, -15625, -11549, -6026, 1, 5574, 9889, 12395, 12866, 11401, 8372, 4346, 0, -3977, -7008, -8716, -8958, -7840, -5669, -2891, 0, 2543, 4383, 5325, 5336, 4545, 3193, 1578, 0, -1296, -2151, -2509, -2409, -1957, -1306,  -610, 0, 440, 677, 724, 630, 457, 268, 107, 1, -52, -61, -48, -26, -11, -3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
};

//功放mute脚控制，用户补充代码
void sin_audio_output_mute(bool mute)
{
    if (mute) {
        // gpio_set_bits(GPIOB_REG, GPIO_PIN_2);
    } else {
        // gpio_reset_bits(GPIOB_REG, GPIO_PIN_2);
    }
}

void sin_res_init(void)
{
    sin_audio_output_mute(1);

    gpio_init_typedef gpio_init_structure;

    gpio_init_structure.gpio_pin = GPIO_PIN_2;
    gpio_init_structure.gpio_dir = GPIO_DIR_OUTPUT;
    gpio_init_structure.gpio_fen = GPIO_FEN_PER;
    gpio_init_structure.gpio_mode = GPIO_MODE_ANALOG;
    gpio_init_structure.gpio_drv = GPIO_DRV_6MA;
    gpio_init(GPIOA_REG, &gpio_init_structure);

    FUNO_PA2SEL(FO_AUDIO);                                    //Map dac output PA2

    sin_res_cb.sta = 0;

    sin_audio_output_mute(0);
}

void sin_res_deinit(void)
{
    sin_res_cb.sta = 0;
    sin_audio_output_mute(1);
    gpio_deinit(GPIOA_REG, GPIO_PIN_2);
    sddac_cmd(DISABLE);
    clk_gate0_cmd(CLK_GATE0_DAC, CLK_DIS);
}

void sin_res_play(int16_t *buf, uint32_t buf_len)
{
#if (SYS_SLEEP_TIME)
    lowpwr_sleep_auto_dis();
#endif //SYS_SLEEP_TIME

    sin_res_cb.sta = 1;
    sin_res_cb.offset = 0;
    sin_res_cb.ibuf_ptr = buf;       //用户修改，播放不同提示音
    sin_res_cb.len = buf_len;

    memset((uint8_t*)sin_res_cb.obuf, 0, sizeof(sin_res_cb.obuf));

    sin_audio_output_mute(1);
    GPIOADE &= ~BIT(2);

    clk_sdadda_clk_set(CLK_SDADDA_CLK_XOSC24M_CLK_2PLL, 0);
    clk_gate0_cmd(CLK_GATE0_DAC, CLK_EN);

    //如果提示音的参数一样，那么把dac初始化放到sin_res_init中可以减少开关dac产生的“噗”声
    sddac_init_typedef sddac_config;
    sddac_config.dma_buf = (uint8_t*)sin_res_cb.obuf;
    sddac_config.dma_size = SDDAC_BUF_SIZE;
    sddac_config.sample_rate = SDDAC_NORMAL_SPR_16k;
    sddac_init(&sddac_config);
    sddac_cmd(ENABLE);
    GPIOADE |= BIT(2);

    sin_audio_output_mute(0);
}

void tone_play_sin_test(void)
{
    sin_res_play((int16_t *)SinData16, sizeof(SinData16)/2);
}

void sin_res_play_proc(void)
{
    if (sin_res_cb.sta == 1) {
        if (sddac_get_flag(SDDAC_IT_ALL_DONE)) {
            sddac_clear_flag(SDDAC_IT_ALL_DONE);
            tone_play_volume_proc(&sin_res_cb.obuf[SDDAC_BUF_SIZE/2], &sin_res_cb.ibuf_ptr[sin_res_cb.offset], SDDAC_BUF_SIZE/2);
            sin_res_cb.offset += SDDAC_BUF_SIZE/2;
        }

        if (sddac_get_flag(SDDAC_IT_HALF_DONE)) {
            sddac_clear_flag(SDDAC_IT_HALF_DONE);
            tone_play_volume_proc(&sin_res_cb.obuf[0], &sin_res_cb.ibuf_ptr[sin_res_cb.offset], SDDAC_BUF_SIZE/2);
            sin_res_cb.offset += SDDAC_BUF_SIZE/2;
        }

        if (sin_res_cb.offset >= sin_res_cb.len) {
            #if (SYS_SLEEP_TIME)
                lowpwr_sleep_auto_en();
            #endif //SYS_SLEEP_TIME
            GPIOADE &= ~BIT(2);
            sddac_cmd(DISABLE);
            sin_res_cb.sta = 0;
        }
    }
}
